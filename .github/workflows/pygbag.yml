name: pygbag_build
on:
  workflow_dispatch:

jobs:
  build-pygbag:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Show repo tree (debug)
        run: |
          echo "GITHUB_WORKSPACE=${GITHUB_WORKSPACE}"
          pwd
          ls -la
          echo "==== full tree ===="
          ls -R . | sed -n '1,200p'

      - name: Install pygbag
        run: pip install pygbag

      - name: Locate main.py anywhere in repo
        id: locate
        run: |
          echo "Searching for main.py..."
          MAIN_PATH="$(find . -maxdepth 6 -type f -name "main.py" -print -quit || true)"
          if [ -z "$MAIN_PATH" ]; then
            echo "ERROR: main.py not found in repo (searched up to 6 levels)."
            ls -R .
            exit 1
          fi
          echo "Found main.py at: $MAIN_PATH"
          # normalize absolute path
          MAIN_ABS="$(realpath "$MAIN_PATH")"
          echo "MAIN_ABS=$MAIN_ABS" >> $GITHUB_ENV
          echo "MAIN_DIR=$(dirname "$MAIN_ABS")" >> $GITHUB_ENV
          echo "MAIN_BASENAME=$(basename "$MAIN_ABS")" >> $GITHUB_ENV

      - name: Show located script info
        run: |
          echo "MAIN_ABS = $MAIN_ABS"
          echo "MAIN_DIR = $MAIN_DIR"
          echo "MAIN_BASENAME = $MAIN_BASENAME"
          echo "ls of main dir:"
          ls -la "$MAIN_DIR" || true

      - name: Clean old build
        run: rm -rf "${GITHUB_WORKSPACE}/build"

      - name: Build for web (run from script directory and force outdir)
        run: |
          cd "$MAIN_DIR"
          echo "PWD: $(pwd)"
          echo "Listing current dir:"
          ls -la
          # build the current directory (.) as the app top-level, and force output to repo build folder
          python -m pygbag --build . --target web --outdir "${GITHUB_WORKSPACE}/build"
        env:
          MAIN_DIR: ${{ env.MAIN_DIR }}

      - name: Verify build output
        run: |
          echo "Build output tree:"
          ls -R "${GITHUB_WORKSPACE}/build" || true
          echo "Contents of build/web (if present):"
          ls -la "${GITHUB_WORKSPACE}/build/web" || true

      - name: Deploy to GitHub Pages
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          branch: gh-pages
          folder: build/web
